<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>EXWATER 스마트 급수 제어</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: 'Arial'; padding: 20px; background: #f2f2f2; }
    h2 { color: #2c3e50; }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .status {
      font-size: 18px;
      font-weight: bold;
    }
    .status.ok { color: green; }
    .status.fail { color: red; }
  </style>
</head>
<body>
  <h2>💧 EXWATER 스마트 급수 대시보드</h2>

  <div class="card">
    <p><strong>모드 (타입):</strong> <span id="type">-</span></p>
    <p><strong>펌프 상태:</strong> <span id="state">-</span></p>
    <p><strong>온도:</strong> <span id="temp">-</span> °C</p>
    <p><strong>습도:</strong> <span id="humi">-</span> %</p>
    <p><strong>토양습도:</strong> <span id="moisture">-</span></p>
    <p><strong>마지막 응답 시각:</strong> <span id="last_time">-</span></p>
    <p class="status" id="connect_status">연결 상태 확인 중...</p>
  </div>

  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyAeHP9-GL_uC4c7i9d1R0QCgd99NdzKWD0",
      authDomain: "exwater01.firebaseapp.com",
      databaseURL: "https://exwater01-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "exwater01",
      storageBucket: "exwater01.appspot.com",
      messagingSenderId: "469173359215",
      appId: "1:469173359215:web:1b924de7c1ff9d0d56c5db"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const $ = id => document.getElementById(id);

    function updateUI(data) {
      $("type").textContent = data.type ?? "-";
      $("state").textContent = data.state ? "ON" : "OFF";
      $("temp").textContent = data.temperature?.toFixed(1) ?? "-";
      $("humi").textContent = data.humidity?.toFixed(1) ?? "-";
      $("moisture").textContent = data.moisture ?? "-";
      $("last_time").textContent = data.last_time ?? "-";

      const now = new Date();
      const last = new Date(data.last_time);
      const diffSec = (now - last) / 1000;

      if (!isNaN(diffSec) && diffSec < 20) {
        $("connect_status").textContent = `✅ 연결 정상 (${Math.floor(diffSec)}초 전 응답)`;
        $("connect_status").className = "status ok";
      } else {
        $("connect_status").textContent = "❌ 연결 끊김";
        $("connect_status").className = "status fail";
      }
    }

    async function fetchDataAndRequest() {
      try {
        await db.ref("/request").set(true);

        const [typeSnap, stateSnap, respSnap] = await Promise.all([
          db.ref("/esp/type").get(),
          db.ref("/esp/state").get(),
          db.ref("/response").get()
        ]);

        updateUI({
          type: typeSnap.val(),
          state: stateSnap.val(),
          temperature: respSnap.child("temperature").val(),
          humidity: respSnap.child("humidity").val(),
          moisture: respSnap.child("moisture").val(),
          last_time: respSnap.child("last_time").val()
        });

      } catch (err) {
        console.error("🔥 Firebase 오류:", err);
        $("connect_status").textContent = "❌ 연결 실패 (Firebase)";
        $("connect_status").className = "status fail";
      }
    }

    // 최초 요청 및 10초 주기 반복
    fetchDataAndRequest();
    setInterval(fetchDataAndRequest, 10000);
  </script>
</body>
</html>
