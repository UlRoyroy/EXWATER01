<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>EXWATER ìŠ¤ë§ˆíŠ¸ ê¸‰ìˆ˜ ì œì–´</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: 'Arial'; padding: 20px; background: #f2f2f2; }
    h2 { color: #2c3e50; }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .status {
      font-size: 18px;
      font-weight: bold;
    }
    .status.ok { color: green; }
    .status.fail { color: red; }
  </style>
</head>
<body>
  <h2>ğŸ’§ EXWATER ìŠ¤ë§ˆíŠ¸ ê¸‰ìˆ˜ ëŒ€ì‹œë³´ë“œ</h2>

  <div class="card">
    <p><strong>ëª¨ë“œ (íƒ€ì…):</strong> <span id="type">-</span></p>
    <p><strong>íŒí”„ ìƒíƒœ:</strong> <span id="state">-</span></p>
    <p><strong>ì˜¨ë„:</strong> <span id="temp">-</span> Â°C</p>
    <p><strong>ìŠµë„:</strong> <span id="humi">-</span> %</p>
    <p><strong>í† ì–‘ìŠµë„:</strong> <span id="moisture">-</span></p>
    <p><strong>ë§ˆì§€ë§‰ ì‘ë‹µ ì‹œê°:</strong> <span id="last_time">-</span></p>
    <p class="status" id="connect_status">ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...</p>
  </div>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyAeHP9-GL_uC4c7i9d1R0QCgd99NdzKWD0",
      authDomain: "exwater01.firebaseapp.com",
      databaseURL: "https://exwater01-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "exwater01",
      storageBucket: "exwater01.appspot.com",
      messagingSenderId: "469173359215",
      appId: "1:469173359215:web:1b924de7c1ff9d0d56c5db"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const $ = id => document.getElementById(id);

    function updateUI(data) {
      $("type").textContent = data.type ?? "-";
      $("state").textContent = data.state ? "ON" : "OFF";
      $("temp").textContent = data.temperature?.toFixed(1) ?? "-";
      $("humi").textContent = data.humidity?.toFixed(1) ?? "-";
      $("moisture").textContent = data.moisture ?? "-";
      $("last_time").textContent = data.last_time ?? "-";

      const now = new Date();
      const last = new Date(data.last_time);
      const diffSec = (now - last) / 1000;

      if (!isNaN(diffSec) && diffSec < 20) {
        $("connect_status").textContent = `âœ… ì—°ê²° ì •ìƒ (${Math.floor(diffSec)}ì´ˆ ì „ ì‘ë‹µ)`;
        $("connect_status").className = "status ok";
      } else {
        $("connect_status").textContent = "âŒ ì—°ê²° ëŠê¹€";
        $("connect_status").className = "status fail";
      }
    }

    async function fetchDataAndRequest() {
      try {
        await db.ref("/request").set(true);

        const [typeSnap, stateSnap, respSnap] = await Promise.all([
          db.ref("/esp/type").get(),
          db.ref("/esp/state").get(),
          db.ref("/response").get()
        ]);

        updateUI({
          type: typeSnap.val(),
          state: stateSnap.val(),
          temperature: respSnap.child("temperature").val(),
          humidity: respSnap.child("humidity").val(),
          moisture: respSnap.child("moisture").val(),
          last_time: respSnap.child("last_time").val()
        });

      } catch (err) {
        console.error("ğŸ”¥ Firebase ì˜¤ë¥˜:", err);
        $("connect_status").textContent = "âŒ ì—°ê²° ì‹¤íŒ¨ (Firebase)";
        $("connect_status").className = "status fail";
      }
    }

    // ìµœì´ˆ ìš”ì²­ ë° 10ì´ˆ ì£¼ê¸° ë°˜ë³µ
    fetchDataAndRequest();
    setInterval(fetchDataAndRequest, 10000);
  </script>
</body>
</html>
